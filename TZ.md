### ТЗ: Переводы, долги, мультивалютность, брокер и крипто в боте финансов

#### 1. Цели и принципы
- **Единый учёт активов и обязательств**: карты, кошельки, брокер, крипто, долги.
- **Консервация денег**: переводы не создают доход/расход, а переносят стоимость между счетами.
- **Мультивалютность**: каждая операция хранит свою валюту; агрегирование в базовой валюте по курсам.
- **Прозрачность и редактируемость**: любой перевод — связка из двух проводок; правка отражается на обеих.
- **Минимум трения в UX**: быстрый мастер перевода и понятные статусы долгов.

#### 2. Термины
- **Счёт (Account)**: `wallet | card | broker_cash | broker_portfolio | crypto | liability_payable | receivable | other`.
- **Транзакция (Transaction)**: `income | expense | transfer_out | transfer_in | fee`.
- **Группа перевода (transfer_group_id)**: UUID для логической связки ног перевода/комиссий.
- **Контрагент (Counterparty)**: человек/организация для долгов/переводов вне собственных счетов.
- **Базовая валюта**: валюта агрегирования (по умолчанию `RUB`).

#### 3. Основные сценарии
- **A. Перевод между своими счетами одной валюты**
  - Пользователь выбирает: Откуда → Куда → Сумма → Дата/комментарий.
  - Записываются 2 проводки: `transfer_out` (источник, сумма X) и `transfer_in` (приёмник, сумма X), связаны `transfer_group_id`.
  - Комиссия (если есть) — отдельная `fee` в источнике, связанная той же группой.
- **B. Перевод между своими счетами с конвертацией валют**
  - Пользователь вводит сумму в валюте источника; бот предлагает курс (из сервиса курсов) и рассчитанную сумму в валюте приёмника, с возможностью ручной правки.
  - Пишутся `transfer_out` (X src_ccy), `transfer_in` (Y dst_ccy), сохраняется `exchange_rate` и `rate_source`.
  - Комиссии (банка/биржи/сети) — отдельные `fee` в счёте источника и/или в отдельном счёте-комиссий.
- **C. Пополнение брокерского**
  - Рекомендуем раздельную модель: `broker_cash` (внутренний кэш) и `broker_portfolio` (внешняя оценка портфеля).
  - Денежные переводы идут в `broker_cash` (как обычный перевод). Стоимость портфеля (`broker_portfolio`) приходит из синка (внешний баланс), не смешивается с кэшем.
- **D. Перевод на чужую карту (возникновение долга)**
  - Если это **долг, который мне должны**: создаётся счёт типа `receivable:<Имя>` (актив). Перевод: из моего счёта в `receivable`; баланс счёта-дебитора растёт (мне должны).
  - Если это **мой долг**: создаётся `liability_payable:<Имя>` (обязательство). Перевод: из `liability_payable` в счёт получателя; баланс обязательства уходит в минус (я должен).
- **E. Возврат долга**
  - Получение от должника: перевод из `receivable` в мой счёт (или кросс-валюта с курсом). Баланс `receivable` уменьшается к 0.
  - Погашение моего долга: перевод из моего счёта в `liability_payable`. Баланс обязательства стремится к 0.
- **F. Крипто он-/офф-рамп**
  - Фиат → биржа: `card/wallet → crypto` (с комиссией). Сеть/обмен — как в B (конвертация, комиссия сетью отдельной `fee`).
  - Свопы токенов: два перевода между суб-счетами крипто-активов с курсом и комиссиями, либо единый UI «Своп» создаёт связку ног.
- **G. Частичные возвраты/чарджбэки**
  - Отражаются как переводы/доходы в исходный счёт с пометкой `is_refund` и ссылкой на исходную транзакцию.

#### 4. Инварианты учёта
- Любой перевод — минимум 2 ноги (`transfer_out`, `transfer_in`) с одним `transfer_group_id`.
- Денежные суммы не создают доход/расход. Доход/расход — только из `income/expense/fee`.
- Сумма в базовой валюте консервативна: `sum(out_base) + sum(fee_base) + delta_fx ≈ sum(in_base)` в пределах допустимой разницы округления.
- Редактирование/удаление перевода изменяет/удаляет всю группу; частичное редактирование недопустимо.

#### 5. Модель данных (дополнения)
- `transactions` (добавить поля):
  - `kind`: enum(`income`,`expense`,`transfer_in`,`transfer_out`,`fee`)
  - `transfer_group_id`: UUID, nullable (группа перевода/комиссий)
  - `related_transaction_id`: FK на вторую ногу (опционально для ускорения навигации)
  - `exchange_rate`: DECIMAL(18,8), nullable; `rate_src`: text(`CBR`,`ECB`,`Binance`,`Manual`)
  - `is_refund`: bool, default false
  - `counterparty_id`: FK (для долгов и внешних переводов)
- `accounts` (расширить):
  - `type`: `wallet|card|broker_cash|broker_portfolio|crypto|liability_payable|receivable|other`
  - Для `broker_portfolio`: `is_external_balance=true` и хранится только снимок внешней оценки.
- Новые таблицы:
  - `counterparties`: `id, name, kind(person|org), default_currency`
  - `currency_rates`: `date, base, quote, rate, source, created_at` (уникальный ключ: `date, base, quote, source`)
  - `scheduled_transfers`: `id, user_id, from_account_id, to_account_id, amount, currency, cron, next_run_at, enabled`

#### 6. Алгоритмы/логика
- **Создание перевода**:
  1) Ввод: from_acc, to_acc/counterparty, amount, currency (если ≠ from_acc.currency), дата, комментарий.
  2) Если валюты счётов различаются — запросить курс: авто из `currency_rates` или ручной ввод; рассчитать сумму во входящем счёте.
  3) Сохранить `transfer_out` (из источника) и `transfer_in` (в приёмник) с единым `transfer_group_id` и связями; `fee` как отдельные записи.
- **Редактирование/удаление**: атомарно по `transfer_group_id`.
- **Импорт/автоподбор**:
  - При загрузке выписки (банки/биржи) алгоритм матчится по сумме/времени/описанию, объединяя исходящие/входящие в одну группу.
  - Для Тинькофф: пополнения на брокер — перенос в `broker_cash`; оценка портфеля остаётся внешним снимком.
- **Мультивалютная агрегация**:
  - Для отчётов суммы приводятся к `BASE_CURRENCY` по курсу на дату операции (close), fallback: средний за день/последний доступный.

#### 7. UX сценарии в боте
- Кнопка «Перевод»: мастер шагов
  - Шаг 1: Откуда (клавиатура счетов)
  - Шаг 2: Куда (мои счета + «→ Контрагент»)
  - Шаг 3: Сумма (автозамена запятая/точка)
  - Шаг 4 (если валюты различны): предложение курса (с кнопками «Принять», «Изменить»)
  - Шаг 5: Комиссия (опционально)
  - Итог: превью с деталями, кнопки «Сохранить»/«Отмена»
- Быстрые фразы (NLU в перспективе): «перевод 500 с тбк на альфа», «отдал 1000 Игорю», «мне вернули 700».
- Долги с людьми: карточки контрагентов, статусы «мне должны/я должен», кнопки «погасить», «напомнить».
- Запланированные переводы: создание/вкл/выкл; уведомления о наступлении.

#### 8. Отчёты и аналитика
- Баланс по счетам (с разбиением на активы/обязательства).
- Переводы: реестр групп с фильтрами (счёт, контрагент, дата, валюта, наличие комиссии, кросс-валюта).
- Долги: список открытых `receivable/liability_payable` с сроками/комментариями.
- Мультивалютная сводка: по базовой валюте + по исходным валютам.

#### 9. Валидации и ограничения
- Нельзя указывать одинаковые `from` и `to`.
- Суммы > 0; комиссия может быть 0.
- Для кросс-валюты обязателен курс (авто/ручной).
- Для `broker_portfolio` операции перевода не допускаются (только внешняя оценка).
- Изменение курса при редактировании пересчитывает входящую сумму (или фиксирует «ручной курс»).

#### 10. API/модель хранения (минимально для реализации)
- Параметры перевода:
  - `from_account_id`, `to_account_id|null`, `counterparty_id|null`, `amount_src`, `currency_src`, `amount_dst|null`, `currency_dst|null`, `exchange_rate|null`, `fees[]`.
- Хранение:
  - Записывать 2..N рядов в `transactions` с общим `transfer_group_id`.
  - `fee` — отдельные строки, привязанные к источнику (или к нужному счёту) с тем же `transfer_group_id`.

#### 11. Примеры
- Перевод 10 000 RUB с `Альфа` на `Т-Банк` без комиссии:
```
transfer_out: -10000 RUB (Альфа), group=G
transfer_in:  +10000 RUB (Т-Банк), group=G
```
- Перевод 100 USD → 9500 RUB, комиссия 100 RUB:
```
transfer_out: -100 USD (USD-карта), rate 95.00, group=G
fee:          -100 RUB (RUB-карта/источник), group=G
transfer_in:  +9500 RUB (RUB-счёт), group=G
```
- Отдал 5000 RUB Игорю (мне должны):
```
transfer_out: -5000 RUB (Нал), group=G, counterparty=Игорь
transfer_in:  +5000 RUB (receivable:Игорь), group=G
```
- Погасил мой долг 2000 RUB Игорю:
```
transfer_out: -2000 RUB (Карта), group=G
transfer_in:  +2000 RUB (liability_payable:Игорь), group=G
```

#### 12. План внедрения (кратко)
1) Расширить модели (`transactions`, `accounts`, `counterparties`, `currency_rates`).
2) Сервис курсов и конвертация в отчётах.
3) Хендлер «Перевод» (мастер) + валидации.
4) Импорт/матчинг пар исходящих/входящих в группы.
5) UI долгов (создание контрагентов, погашение, напоминания).
6) Тесты инвариантов (консервация, кросс-валюта, комиссии).

